# infra-framework 基础框架

### 一. 项目职责

本项目基本涵盖通信框架的所有依赖项，以grpc为通信的基础核心，围绕其建立的微服务生态，包括注册中心、配置中心、trace、日志、度量等。

为业务的开发提供便捷能力，打通各类中间件，最大可能开箱即用。

### 二. 模块说明

##### infra-bom 统一版本管理

##### infra-framework-starter 统一对外starter

##### infra-common 通用模块，如常用工具、util、常量、公共model、统一result、线程池等

##### infra-config 配置中心模块，提供配置中心的封装，目前使用apollo

##### infra-registry 注册中心模块，提供注册中心的封装，暂定使用nacos

##### infra-grpc    grpc模块，提供底层通信扩展的封装

##### infra-logger 日志模块，提供日志能力的封装以及基于日志动态debug的能力

##### infra-metrics 度量模块，提供度量指标封装，目前使用cat

##### infra-trace   trace模块，提供微服务间trace能力封装，目前使用zipkin

##### infra-traffic 流量管控模块，提供grpc间的负载、路由、限流、熔断、降级等能力，暂定使用sentinel

##### infra-cache 缓存模块，提供常用缓存操作的封装

##### infra-mq     mq模块，提供mq类统一封装，提供便捷操作

##### infra-datasource 数据源模块，提供数据源操作统一封装

### 三. 模块的核心目标

#### infra-bom

对常用基础组建进行严格的版本管理，非必要不随意升级版本

#### infra-common

供框架内部使用的common

#### infra-config

1. 封装apollo的接入，可根据指定的profiles指向不同环境的集群
2. 根据项目名称，动态在项目启动时生成apollo项目
3. 提供关闭开关，完全使用原生用法
4. 调研apollo内部配置信息同步原则，对同步模式(推、拉)，配置缓存，连接能力，集群模式等实现做到心中有数，具备快速解决故障的能力
5. 在不同AZ提供线上的备份集群
6. 研究apollo配置内容的备份和导入能力，定时往备集群进行备份

#### infra-registry

1. 封装注册中心(nacos)的接入，可根据指定的profiles指向不同环境的集群
2. 提供关闭开关，完全使用原生用法
4. 在不同的AZ、region搭建多中心，具备一键切换备集群的能力
3. 调研注册中心(nacos)实现，对心跳同步，缓存时间，连接能力，路由规则，集群模式等实现做到心中有数，具备快速解决故障的能力

#### infra-grpc

1. 提供grpc通信能力的封装
2. 对客户端和服务端进行扩展增强
3. 根据grpc性能指标，完善grpc性能，诸如io、协议、线程池等
4. 打通与注册中心、配置中心的接入

#### infra-logger

1. 提供默认的日志参数配置，封装logback-spring.xml的定义并提供appender扩展能力（pattern、写盘位置、日志分类）
2. 引入动态插入日志和切换日志级别能力
3. 提供核心日志脱敏能力（如有必要）

#### infra-metrics

1. 封装cat的接入，可根据指定的profiles指向不同环境的集群
2. 打通cat与grpc的接入，完成对grpc调用的性能监控
3. 根据项目名称，动态在项目启动时配置cat项目
4. 提供关闭开关，完全使用原生用法
5. 如有可能，封装一下cat手动埋点的常用操作，为后续定制化、自动化打点打下基础，未来也好统一天眼查的性能监控组件

#### infra-trace

1. 封装trace和zipkin的接入，可根据指定的profiles指向不同环境集群
2. 集成trace在grpc间的传递
3. 集成trace在mq间的传递
4. 调研trace与zipkin的同步机制，以及对性能损耗影响，如有可能，将传输过程由同步转为异步

#### infra-traffic

1. 封装sentinel的接入
2. 集成sentinel和grpc、apollo、nacos的配置
3. 调研sentinel内部实现，对分布式限流、熔断、降级等实现做到心中有数，具备快速解决故障的能力

#### infra-cache

1. 封装redis接入，可根据指定的profiles指向不同环境集群
2. 封装常用的redis操作，如增删改查、分布式锁等

#### infra-mq

1. 封装kafka（rocketmq）接入，可根据指定的profiles指向不同环境(单)集群
2. 封装mq的基本操作，扩展trace、metrics等
3. 比较依赖mq平台的能力，选择集群、创建topic等

#### infra-datasource

1. 封装数据源配置，默认提供优化连接池参数配置，屏蔽数据库密码等
2. 提供多数据源接入封装

### 四. 编码原则

1. 尽可能的减少业务依赖本框架所需要配置内容，如配置参数、地址、选项，尽量提供默认值、开关等。
2. 如有可能，尽量以无感方式扩展能力，或尽量简化封装使用，常用扩展的一般方式为`注解`、`动态代理`、`SPI`、`delegate模式`、`ApplicationEvent`、`BeanPostProcessor`
3. 部分模块尽可能提供独立使用能力

### 五. 注释命名

![img_2.png](img_2.png)

### 六. 文档输出

1. 需求文档（实现目标，排期计划，涉及模块）
2. 使用文档（常见用法、高级用法、原理-增强说明、demo说明）
3. 迁移方案（如有必要）
4. 压测报告（如有必要）
5. 演练报告（如有必要）
6. 兜底能力（稳定性保障方案，down机影响范围，补救方案）

### 七. 开发/上线流程

1. 确定实现目标及达成效果
2. 实现前先跟changbo及相关人员对实现方案进行review（包括迁移方案）
3. 开发完成后，组织相关人员进行code review
4. 进行压测、故障演练等
5. 指定回滚方案
6. 开发、测试、预发灰度
7. 线上灰度 -> 全量

作为核心底层框架，上线前必须做好严格的流程执行及预案，杜绝冒进。


